'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.default = build;

var _tokenizerEventHandlers = require('../parser/tokenizer-event-handlers');

var _utils = require('../utils');

var _util = require('./util');

function unreachable() {
    throw new Error('unreachable');
}
function build(ast) {
    if (!ast) {
        return '';
    }
    const output = [];
    switch (ast.type) {
        case 'Program':
            {
                const chainBlock = ast['chained'] && ast.body[0];
                if (chainBlock) {
                    chainBlock['chained'] = true;
                }
                const body = buildEach(ast.body).join('');
                output.push(body);
            }
            break;
        case 'ElementNode':
            output.push('<', ast.tag);
            if (ast.attributes.length) {
                output.push(' ', buildEach(ast.attributes).join(' '));
            }
            if (ast.modifiers.length) {
                output.push(' ', buildEach(ast.modifiers).join(' '));
            }
            if (ast.comments.length) {
                output.push(' ', buildEach(ast.comments).join(' '));
            }
            if (ast.blockParams.length) {
                output.push(' ', 'as', ' ', `|${ast.blockParams.join(' ')}|`);
            }
            if (_tokenizerEventHandlers.voidMap[ast.tag]) {
                if (ast.selfClosing) {
                    output.push(' /');
                }
                output.push('>');
            } else {
                output.push('>');
                output.push.apply(output, buildEach(ast.children));
                output.push('</', ast.tag, '>');
            }
            break;
        case 'AttrNode':
            if (ast.value.type === 'TextNode') {
                if (ast.value.chars !== '') {
                    output.push(ast.name, '=');
                    output.push('"', (0, _util.escapeAttrValue)(ast.value.chars), '"');
                } else {
                    output.push(ast.name);
                }
            } else {
                output.push(ast.name, '=');
                // ast.value is mustache or concat
                output.push(build(ast.value));
            }
            break;
        case 'ConcatStatement':
            output.push('"');
            ast.parts.forEach(node => {
                if (node.type === 'TextNode') {
                    output.push((0, _util.escapeAttrValue)(node.chars));
                } else {
                    output.push(build(node));
                }
            });
            output.push('"');
            break;
        case 'TextNode':
            output.push((0, _util.escapeText)(ast.chars));
            break;
        case 'MustacheStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'MustacheCommentStatement':
            {
                output.push(compactJoin(['{{!--', ast.value, '--}}']));
            }
            break;
        case 'ElementModifierStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'PathExpression':
            output.push(ast.original);
            break;
        case 'SubExpression':
            {
                output.push('(', pathParams(ast), ')');
            }
            break;
        case 'BooleanLiteral':
            output.push(ast.value ? 'true' : 'false');
            break;
        case 'BlockStatement':
            {
                const lines = [];
                if (ast['chained']) {
                    lines.push(['{{else ', pathParams(ast), '}}'].join(''));
                } else {
                    lines.push(openBlock(ast));
                }
                lines.push(build(ast.program));
                if (ast.inverse) {
                    if (!ast.inverse['chained']) {
                        lines.push('{{else}}');
                    }
                    lines.push(build(ast.inverse));
                }
                if (!ast['chained']) {
                    lines.push(closeBlock(ast));
                }
                output.push(lines.join(''));
            }
            break;
        case 'PartialStatement':
            {
                output.push(compactJoin(['{{>', pathParams(ast), '}}']));
            }
            break;
        case 'CommentStatement':
            {
                output.push(compactJoin(['<!--', ast.value, '-->']));
            }
            break;
        case 'StringLiteral':
            {
                output.push(`"${ast.value}"`);
            }
            break;
        case 'NumberLiteral':
            {
                output.push(String(ast.value));
            }
            break;
        case 'UndefinedLiteral':
            {
                output.push('undefined');
            }
            break;
        case 'NullLiteral':
            {
                output.push('null');
            }
            break;
        case 'Hash':
            {
                output.push(ast.pairs.map(pair => {
                    return build(pair);
                }).join(' '));
            }
            break;
        case 'HashPair':
            {
                output.push(`${ast.key}=${build(ast.value)}`);
            }
            break;
    }
    return output.join('');
}
function compact(array) {
    const newArray = [];
    array.forEach(a => {
        if (typeof a !== 'undefined' && a !== null && a !== '') {
            newArray.push(a);
        }
    });
    return newArray;
}
function buildEach(asts) {
    return asts.map(build);
}
function pathParams(ast) {
    let path;
    switch (ast.type) {
        case 'MustacheStatement':
        case 'SubExpression':
        case 'ElementModifierStatement':
        case 'BlockStatement':
            if ((0, _utils.isLiteral)(ast.path)) {
                return String(ast.path.value);
            }
            path = build(ast.path);
            break;
        case 'PartialStatement':
            path = build(ast.name);
            break;
        default:
            return unreachable();
    }
    return compactJoin([path, buildEach(ast.params).join(' '), build(ast.hash)], ' ');
}
function compactJoin(array, delimiter) {
    return compact(array).join(delimiter || '');
}
function blockParams(block) {
    const params = block.program.blockParams;
    if (params.length) {
        return ` as |${params.join(' ')}|`;
    }
    return null;
}
function openBlock(block) {
    return ['{{#', pathParams(block), blockParams(block), '}}'].join('');
}
function closeBlock(block) {
    return ['{{/', build(block.path), '}}'].join('');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJpbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9zeW50YXgvbGliL2dlbmVyYXRpb24vcHJpbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVBLEFBQU8sQUFBRSxBQUFPLEFBQUUsQUFBTSxBQUFvQyxBQUFDOztBQUM3RCxBQUFPLEFBQUUsQUFBUyxBQUFFLEFBQU0sQUFBVSxBQUFDOztBQUNyQyxBQUFPLEFBQUUsQUFBVSxBQUFFLEFBQWUsQUFBRSxBQUFNLEFBQVEsQUFBQzs7QUFFckQsU0FBUyxBQUFXLGNBQ2xCO1VBQU0sSUFBSSxBQUFLLE1BQUMsQUFBYSxBQUFDLEFBQUMsQUFDakMsQUFBQztBQUVELEFBQU0sQUFBQyxBQUFPO1NBQVUsQUFBSyxNQUFDLEFBQWEsS0FDekM7UUFBSSxDQUFDLEFBQUcsS0FBRSxBQUNSO2VBQU8sQUFBRSxBQUFDLEFBQ1g7QUFDRDtVQUFNLEFBQU0sU0FBYSxBQUFFLEFBQUMsQUFFNUI7WUFBUSxBQUFHLElBQUMsQUFBSSxBQUFFLEFBQ2hCO2FBQUssQUFBUyxBQUNaO0FBQ0U7c0JBQU0sQUFBVSxhQUFHLEFBQUcsSUFBQyxBQUFTLEFBQUMsY0FBSSxBQUFHLElBQUMsQUFBSSxLQUFDLEFBQUMsQUFBQyxBQUFDLEFBQ2pEO29CQUFJLEFBQVUsWUFBRSxBQUNkLEFBQVU7K0JBQUMsQUFBUyxBQUFDLGFBQUcsQUFBSSxBQUFDLEFBQzlCO0FBQ0Q7c0JBQU0sQUFBSSxPQUFHLEFBQVMsVUFBQyxBQUFHLElBQUMsQUFBSSxBQUFDLE1BQUMsQUFBSSxLQUFDLEFBQUUsQUFBQyxBQUFDLEFBQzFDLEFBQU07dUJBQUMsQUFBSSxLQUFDLEFBQUksQUFBQyxBQUFDLEFBQ25CO0FBQ0QsQUFBTTtBQUNSO2FBQUssQUFBYSxBQUNoQixBQUFNO21CQUFDLEFBQUksS0FBQyxBQUFHLEtBQUUsQUFBRyxJQUFDLEFBQUcsQUFBQyxBQUFDLEFB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RSxBQUFHLEFBQUMsQUFBQyxBQUNwRixBQUFDOztBQUVELFNBQVMsQUFBVyxZQUFDLEFBQXVCLE9BQUUsQUFBa0IsV0FDOUQ7V0FBTyxBQUFPLFFBQUMsQUFBSyxBQUFDLE9BQUMsQUFBSSxLQUFDLEFBQVMsYUFBSSxBQUFFLEFBQUMsQUFBQyxBQUM5QyxBQUFDOztBQUVELFNBQVMsQUFBVyxZQUFDLEFBQXlCLE9BQzVDO1VBQU0sQUFBTSxTQUFHLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBVyxBQUFDLEFBQ3pDO1FBQUksQUFBTSxPQUFDLEFBQU0sUUFBRSxBQUNqQixBQUFPO3VCQUFRLEFBQU0sT0FBQyxBQUFJLEtBQUMsQUFBRyxBQUFDLEFBQUcsQUFBQyxJQUNwQztBQUVEO1dBQU8sQUFBSSxBQUFDLEFBQ2QsQUFBQzs7QUFFRCxTQUFTLEFBQVMsVUFBQyxBQUF5QixPQUMxQztXQUFPLENBQUMsQUFBSyxPQUFFLEFBQVUsV0FBQyxBQUFLLEFBQUMsUUFBRSxBQUFXLFlBQUMsQUFBSyxBQUFDLFFBQUUsQUFBSSxBQUFDLE1BQUMsQUFBSSxLQUFDLEFBQUUsQUFBQyxBQUFDLEFBQ3ZFLEFBQUM7O0FBRUQsU0FBUyxBQUFVLFdBQUMsQUFBVSxPQUM1QjtXQUFPLENBQUMsQUFBSyxPQUFFLEFBQUssTUFBQyxBQUFLLE1BQUMsQUFBSSxBQUFDLE9BQUUsQUFBSSxBQUFDLE1BQUMsQUFBSSxLQUFDLEFBQUUsQUFBQyxBQUFDLEFBQ25ELEFBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPcHRpb24gfSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCAqIGFzIEhCUyBmcm9tICcuLi90eXBlcy9ub2Rlcyc7XG5pbXBvcnQgeyB2b2lkTWFwIH0gZnJvbSAnLi4vcGFyc2VyL3Rva2VuaXplci1ldmVudC1oYW5kbGVycyc7XG5pbXBvcnQgeyBpc0xpdGVyYWwgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBlc2NhcGVUZXh0LCBlc2NhcGVBdHRyVmFsdWUgfSBmcm9tICcuL3V0aWwnO1xuXG5mdW5jdGlvbiB1bnJlYWNoYWJsZSgpOiBuZXZlciB7XG4gIHRocm93IG5ldyBFcnJvcigndW5yZWFjaGFibGUnKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gYnVpbGQoYXN0OiBIQlMuTm9kZSk6IHN0cmluZyB7XG4gIGlmICghYXN0KSB7XG4gICAgcmV0dXJuICcnO1xuICB9XG4gIGNvbnN0IG91dHB1dDogc3RyaW5nW10gPSBbXTtcblxuICBzd2l0Y2ggKGFzdC50eXBlKSB7XG4gICAgY2FzZSAnUHJvZ3JhbSc6XG4gICAgICB7XG4gICAgICAgIGNvbnN0IGNoYWluQmxvY2sgPSBhc3RbJ2NoYWluZWQnXSAmJiBhc3QuYm9keVswXTtcbiAgICAgICAgaWYgKGNoYWluQmxvY2spIHtcbiAgICAgICAgICBjaGFpbkJsb2NrWydjaGFpbmVkJ10gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGJvZHkgPSBidWlsZEVhY2goYXN0LmJvZHkpLmpvaW4oJycpO1xuICAgICAgICBvdXRwdXQucHVzaChib2R5KTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0VsZW1lbnROb2RlJzpcbiAgICAgIG91dHB1dC5wdXNoKCc8JywgYXN0LnRhZyk7XG4gICAgICBpZiAoYXN0LmF0dHJpYnV0ZXMubGVuZ3RoKSB7XG4gICAgICAgIG91dHB1dC5wdXNoKCcgJywgYnVpbGRFYWNoKGFzdC5hdHRyaWJ1dGVzKS5qb2luKCcgJykpO1xuICAgICAgfVxuICAgICAgaWYgKGFzdC5tb2RpZmllcnMubGVuZ3RoKSB7XG4gICAgICAgIG91dHB1dC5wdXNoKCcgJywgYnVpbGRFYWNoKGFzdC5tb2RpZmllcnMpLmpvaW4oJyAnKSk7XG4gICAgICB9XG4gICAgICBpZiAoYXN0LmNvbW1lbnRzLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQucHVzaCgnICcsIGJ1aWxkRWFjaChhc3QuY29tbWVudHMpLmpvaW4oJyAnKSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChhc3QuYmxvY2tQYXJhbXMubGVuZ3RoKSB7XG4gICAgICAgIG91dHB1dC5wdXNoKCcgJywgJ2FzJywgJyAnLCBgfCR7YXN0LmJsb2NrUGFyYW1zLmpvaW4oJyAnKX18YCk7XG4gICAgICB9XG5cbiAgICAgIGlmICh2b2lkTWFwW2FzdC50YWddKSB7XG4gICAgICAgIGlmIChhc3Quc2VsZkNsb3NpbmcpIHtcbiAgICAgICAgICBvdXRwdXQucHVzaCgnIC8nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG91dHB1dC5wdXNoKCc+Jyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvdXRwdXQucHVzaCgnPicpO1xuICAgICAgICBvdXRwdXQucHVzaC5hcHBseShvdXRwdXQsIGJ1aWxkRWFjaChhc3QuY2hpbGRyZW4pKTtcbiAgICAgICAgb3V0cHV0LnB1c2goJzwvJywgYXN0LnRhZywgJz4nKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0F0dHJOb2RlJzpcbiAgICAgIGlmIChhc3QudmFsdWUudHlwZSA9PT0gJ1RleHROb2RlJykge1xuICAgICAgICBpZiAoYXN0LnZhbHVlLmNoYXJzICE9PSAnJykge1xuICAgICAgICAgIG91dHB1dC5wdXNoKGFzdC5uYW1lLCAnPScpO1xuICAgICAgICAgIG91dHB1dC5wdXNoKCdcIicsIGVzY2FwZUF0dHJWYWx1ZShhc3QudmFsdWUuY2hhcnMpLCAnXCInKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvdXRwdXQucHVzaChhc3QubmFtZSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG91dHB1dC5wdXNoKGFzdC5uYW1lLCAnPScpO1xuICAgICAgICAvLyBhc3QudmFsdWUgaXMgbXVzdGFjaGUgb3IgY29uY2F0XG4gICAgICAgIG91dHB1dC5wdXNoKGJ1aWxkKGFzdC52YWx1ZSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnQ29uY2F0U3RhdGVtZW50JzpcbiAgICAgIG91dHB1dC5wdXNoKCdcIicpO1xuICAgICAgYXN0LnBhcnRzLmZvckVhY2goKG5vZGU6IEhCUy5UZXh0Tm9kZSB8IEhCUy5NdXN0YWNoZVN0YXRlbWVudCkgPT4ge1xuICAgICAgICBpZiAobm9kZS50eXBlID09PSAnVGV4dE5vZGUnKSB7XG4gICAgICAgICAgb3V0cHV0LnB1c2goZXNjYXBlQXR0clZhbHVlKG5vZGUuY2hhcnMpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvdXRwdXQucHVzaChidWlsZChub2RlKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgb3V0cHV0LnB1c2goJ1wiJyk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdUZXh0Tm9kZSc6XG4gICAgICBvdXRwdXQucHVzaChlc2NhcGVUZXh0KGFzdC5jaGFycykpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnTXVzdGFjaGVTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJ3t7JywgcGF0aFBhcmFtcyhhc3QpLCAnfX0nXSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnTXVzdGFjaGVDb21tZW50U3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyd7eyEtLScsIGFzdC52YWx1ZSwgJy0tfX0nXSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnRWxlbWVudE1vZGlmaWVyU3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyd7eycsIHBhdGhQYXJhbXMoYXN0KSwgJ319J10pKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1BhdGhFeHByZXNzaW9uJzpcbiAgICAgIG91dHB1dC5wdXNoKGFzdC5vcmlnaW5hbCk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdTdWJFeHByZXNzaW9uJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJygnLCBwYXRoUGFyYW1zKGFzdCksICcpJyk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdCb29sZWFuTGl0ZXJhbCc6XG4gICAgICBvdXRwdXQucHVzaChhc3QudmFsdWUgPyAndHJ1ZScgOiAnZmFsc2UnKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0Jsb2NrU3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgY29uc3QgbGluZXM6IHN0cmluZ1tdID0gW107XG5cbiAgICAgICAgaWYgKGFzdFsnY2hhaW5lZCddKSB7XG4gICAgICAgICAgbGluZXMucHVzaChbJ3t7ZWxzZSAnLCBwYXRoUGFyYW1zKGFzdCksICd9fSddLmpvaW4oJycpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsaW5lcy5wdXNoKG9wZW5CbG9jayhhc3QpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxpbmVzLnB1c2goYnVpbGQoYXN0LnByb2dyYW0pKTtcblxuICAgICAgICBpZiAoYXN0LmludmVyc2UpIHtcbiAgICAgICAgICBpZiAoIWFzdC5pbnZlcnNlWydjaGFpbmVkJ10pIHtcbiAgICAgICAgICAgIGxpbmVzLnB1c2goJ3t7ZWxzZX19Jyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxpbmVzLnB1c2goYnVpbGQoYXN0LmludmVyc2UpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghYXN0WydjaGFpbmVkJ10pIHtcbiAgICAgICAgICBsaW5lcy5wdXNoKGNsb3NlQmxvY2soYXN0KSk7XG4gICAgICAgIH1cblxuICAgICAgICBvdXRwdXQucHVzaChsaW5lcy5qb2luKCcnKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdQYXJ0aWFsU3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyd7ez4nLCBwYXRoUGFyYW1zKGFzdCksICd9fSddKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdDb21tZW50U3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyc8IS0tJywgYXN0LnZhbHVlLCAnLS0+J10pKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1N0cmluZ0xpdGVyYWwnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChgXCIke2FzdC52YWx1ZX1cImApO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnTnVtYmVyTGl0ZXJhbCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKFN0cmluZyhhc3QudmFsdWUpKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1VuZGVmaW5lZExpdGVyYWwnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaCgndW5kZWZpbmVkJyk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdOdWxsTGl0ZXJhbCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKCdudWxsJyk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdIYXNoJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goXG4gICAgICAgICAgYXN0LnBhaXJzXG4gICAgICAgICAgICAubWFwKHBhaXIgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gYnVpbGQocGFpcik7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmpvaW4oJyAnKVxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnSGFzaFBhaXInOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChgJHthc3Qua2V5fT0ke2J1aWxkKGFzdC52YWx1ZSl9YCk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgfVxuICByZXR1cm4gb3V0cHV0LmpvaW4oJycpO1xufVxuXG5mdW5jdGlvbiBjb21wYWN0KGFycmF5OiBPcHRpb248c3RyaW5nPltdKTogc3RyaW5nW10ge1xuICBjb25zdCBuZXdBcnJheTogYW55W10gPSBbXTtcbiAgYXJyYXkuZm9yRWFjaChhID0+IHtcbiAgICBpZiAodHlwZW9mIGEgIT09ICd1bmRlZmluZWQnICYmIGEgIT09IG51bGwgJiYgYSAhPT0gJycpIHtcbiAgICAgIG5ld0FycmF5LnB1c2goYSk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIG5ld0FycmF5O1xufVxuXG5mdW5jdGlvbiBidWlsZEVhY2goYXN0czogSEJTLk5vZGVbXSk6IHN0cmluZ1tdIHtcbiAgcmV0dXJuIGFzdHMubWFwKGJ1aWxkKTtcbn1cblxuZnVuY3Rpb24gcGF0aFBhcmFtcyhhc3Q6IEhCUy5Ob2RlKTogc3RyaW5nIHtcbiAgbGV0IHBhdGg6IHN0cmluZztcblxuICBzd2l0Y2ggKGFzdC50eXBlKSB7XG4gICAgY2FzZSAnTXVzdGFjaGVTdGF0ZW1lbnQnOlxuICAgIGNhc2UgJ1N1YkV4cHJlc3Npb24nOlxuICAgIGNhc2UgJ0VsZW1lbnRNb2RpZmllclN0YXRlbWVudCc6XG4gICAgY2FzZSAnQmxvY2tTdGF0ZW1lbnQnOlxuICAgICAgaWYgKGlzTGl0ZXJhbChhc3QucGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIFN0cmluZyhhc3QucGF0aC52YWx1ZSk7XG4gICAgICB9XG5cbiAgICAgIHBhdGggPSBidWlsZChhc3QucGF0aCk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdQYXJ0aWFsU3RhdGVtZW50JzpcbiAgICAgIHBhdGggPSBidWlsZChhc3QubmFtZSk7XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIHVucmVhY2hhYmxlKCk7XG4gIH1cblxuICByZXR1cm4gY29tcGFjdEpvaW4oW3BhdGgsIGJ1aWxkRWFjaChhc3QucGFyYW1zKS5qb2luKCcgJyksIGJ1aWxkKGFzdC5oYXNoKV0sICcgJyk7XG59XG5cbmZ1bmN0aW9uIGNvbXBhY3RKb2luKGFycmF5OiBPcHRpb248c3RyaW5nPltdLCBkZWxpbWl0ZXI/OiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gY29tcGFjdChhcnJheSkuam9pbihkZWxpbWl0ZXIgfHwgJycpO1xufVxuXG5mdW5jdGlvbiBibG9ja1BhcmFtcyhibG9jazogSEJTLkJsb2NrU3RhdGVtZW50KTogT3B0aW9uPHN0cmluZz4ge1xuICBjb25zdCBwYXJhbXMgPSBibG9jay5wcm9ncmFtLmJsb2NrUGFyYW1zO1xuICBpZiAocGFyYW1zLmxlbmd0aCkge1xuICAgIHJldHVybiBgIGFzIHwke3BhcmFtcy5qb2luKCcgJyl9fGA7XG4gIH1cblxuICByZXR1cm4gbnVsbDtcbn1cblxuZnVuY3Rpb24gb3BlbkJsb2NrKGJsb2NrOiBIQlMuQmxvY2tTdGF0ZW1lbnQpOiBzdHJpbmcge1xuICByZXR1cm4gWyd7eyMnLCBwYXRoUGFyYW1zKGJsb2NrKSwgYmxvY2tQYXJhbXMoYmxvY2spLCAnfX0nXS5qb2luKCcnKTtcbn1cblxuZnVuY3Rpb24gY2xvc2VCbG9jayhibG9jazogYW55KTogc3RyaW5nIHtcbiAgcmV0dXJuIFsne3svJywgYnVpbGQoYmxvY2sucGF0aCksICd9fSddLmpvaW4oJycpO1xufVxuIl19