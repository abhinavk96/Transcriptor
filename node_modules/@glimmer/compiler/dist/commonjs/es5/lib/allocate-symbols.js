"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.SymbolAllocator = undefined;

var _util = require("@glimmer/util");

var _createClass = function () {
    function defineProperties(target, props) {
        for (var i = 0; i < props.length; i++) {
            var descriptor = props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if ("value" in descriptor) descriptor.writable = true;Object.defineProperty(target, descriptor.key, descriptor);
        }
    }return function (Constructor, protoProps, staticProps) {
        if (protoProps) defineProperties(Constructor.prototype, protoProps);if (staticProps) defineProperties(Constructor, staticProps);return Constructor;
    };
}();

function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
        throw new TypeError("Cannot call a class as a function");
    }
}

var SymbolAllocator = exports.SymbolAllocator = function () {
    function SymbolAllocator(ops) {
        _classCallCheck(this, SymbolAllocator);

        this.ops = ops;
        this.symbolStack = new _util.Stack();
    }

    SymbolAllocator.prototype.process = function process() {
        var out = [];
        var ops = this.ops;

        for (var i = 0; i < ops.length; i++) {
            var op = ops[i];
            var result = this.dispatch(op);
            if (result === undefined) {
                out.push(op);
            } else {
                out.push(result);
            }
        }
        return out;
    };

    SymbolAllocator.prototype.dispatch = function dispatch(op) {
        var name = op[0];
        var operand = op[1];
        return this[name](operand);
    };

    SymbolAllocator.prototype.startProgram = function startProgram(op) {
        this.symbolStack.push(op['symbols']);
    };

    SymbolAllocator.prototype.endProgram = function endProgram(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.startBlock = function startBlock(op) {
        this.symbolStack.push(op['symbols']);
    };

    SymbolAllocator.prototype.endBlock = function endBlock(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.flushElement = function flushElement(op) {
        this.symbolStack.push(op['symbols']);
    };

    SymbolAllocator.prototype.closeElement = function closeElement(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.closeComponent = function closeComponent(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.closeDynamicComponent = function closeDynamicComponent(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.attrSplat = function attrSplat(_op) {
        return ['attrSplat', this.symbols.allocateBlock('attrs')];
    };

    SymbolAllocator.prototype.get = function get(op) {
        var name = op[0],
            rest = op[1];

        if (name === 0) {
            return ['get', [0, rest]];
        }
        if (isLocal(name, this.symbols)) {
            var head = this.symbols.get(name);
            return ['get', [head, rest]];
        } else if (name[0] === '@') {
            var _head = this.symbols.allocateNamed(name);
            return ['get', [_head, rest]];
        } else {
            return ['maybeLocal', [name].concat(rest)];
        }
    };

    SymbolAllocator.prototype.maybeGet = function maybeGet(op) {
        var name = op[0],
            rest = op[1];

        if (name === 0) {
            return ['get', [0, rest]];
        }
        if (isLocal(name, this.symbols)) {
            var head = this.symbols.get(name);
            return ['get', [head, rest]];
        } else if (name[0] === '@') {
            var _head2 = this.symbols.allocateNamed(name);
            return ['get', [_head2, rest]];
        } else if (rest.length === 0) {
            return ['unknown', name];
        } else {
            return ['maybeLocal', [name].concat(rest)];
        }
    };

    SymbolAllocator.prototype.yield = function _yield(op) {
        if (op === 0) {
            throw new Error('Cannot yield to this');
        }
        return ['yield', this.symbols.allocateBlock(op)];
    };

    SymbolAllocator.prototype.debugger = function _debugger(_op) {
        return ['debugger', this.symbols.getEvalInfo()];
    };

    SymbolAllocator.prototype.hasBlock = function hasBlock(op) {
        if (op === 0) {
            throw new Error('Cannot hasBlock this');
        }
        return ['hasBlock', this.symbols.allocateBlock(op)];
    };

    SymbolAllocator.prototype.hasBlockParams = function hasBlockParams(op) {
        if (op === 0) {
            throw new Error('Cannot hasBlockParams this');
        }
        return ['hasBlockParams', this.symbols.allocateBlock(op)];
    };

    SymbolAllocator.prototype.partial = function partial(_op) {
        return ['partial', this.symbols.getEvalInfo()];
    };

    SymbolAllocator.prototype.text = function text(_op) {};

    SymbolAllocator.prototype.comment = function comment(_op) {};

    SymbolAllocator.prototype.openComponent = function openComponent(_op) {};

    SymbolAllocator.prototype.openElement = function openElement(_op) {};

    SymbolAllocator.prototype.openSplattedElement = function openSplattedElement(_op) {};

    SymbolAllocator.prototype.staticArg = function staticArg(_op) {};

    SymbolAllocator.prototype.dynamicArg = function dynamicArg(_op) {};

    SymbolAllocator.prototype.staticAttr = function staticAttr(_op) {};

    SymbolAllocator.prototype.trustingAttr = function trustingAttr(_op) {};

    SymbolAllocator.prototype.dynamicAttr = function dynamicAttr(_op) {};

    SymbolAllocator.prototype.modifier = function modifier(_op) {};

    SymbolAllocator.prototype.append = function append(_op) {};

    SymbolAllocator.prototype.block = function block(_op) {};

    SymbolAllocator.prototype.literal = function literal(_op) {};

    SymbolAllocator.prototype.helper = function helper(_op) {};

    SymbolAllocator.prototype.unknown = function unknown(_op) {};

    SymbolAllocator.prototype.maybeLocal = function maybeLocal(_op) {};

    SymbolAllocator.prototype.prepareArray = function prepareArray(_op) {};

    SymbolAllocator.prototype.prepareObject = function prepareObject(_op) {};

    SymbolAllocator.prototype.concat = function concat(_op) {};

    _createClass(SymbolAllocator, [{
        key: 'symbols',
        get: function get() {
            return this.symbolStack.current;
        }
    }]);

    return SymbolAllocator;
}();
function isLocal(name, symbols) {
    return symbols && symbols.has(name);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxsb2NhdGUtc3ltYm9scy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi9hbGxvY2F0ZS1zeW1ib2xzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFHQSxBQUFPLEFBQUUsQUFBSyxBQUFFLEFBQU0sQUFBRSxBQUFNLEFBQWUsQUFBQyxBQWlCOUMsQUFBTTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBQU8sQUFBZSxBQUkxQjs2QkFBb0IsQUFBZ0IsS0FBaEI7OzthQUFHLE1BRmYsQUFFWSxBQUFHLEFBQWE7YUFGakIsY0FBRyxBQUFJLEFBQUssQUFBZSxBQUFDLEFBRVIsQUFBQyxBQUV4QyxBQUFPOzs7O1lBQ0QsQUFBRyxNQUFZLEFBQUUsQUFBQyxBQUN0QixBQUFJLEFBREo7WUFDTSxBQUFHLEFBQUUsTUFBRyxBQUFJLEFBQUMsQUFFbkI7O2FBQUssSUFBSSxBQUFDLElBQUcsQUFBQyxHQUFFLEFBQUMsSUFBRyxBQUFHLElBQUMsQUFBTSxRQUFFLEFBQUMsQUFBRSxLQUFFLEFBQ25DO2dCQUFJLEFBQUUsS0FBRyxBQUFHLElBQUMsQUFBQyxBQUFDLEFBQUMsQUFDaEI7Z0JBQUksQUFBTSxTQUFHLEFBQUksS0FBQyxBQUFRLFNBQUMsQUFBRSxBQUFDLEFBQUMsQUFFL0I7Z0JBQUksQUFBTSxXQUFLLEFBQVMsV0FBRSxBQUN4QixBQUFHO29CQUFDLEFBQUksS0FBQyxBQUFXLEFBQUMsQUFBQyxBQUN2QjttQkFBTSxBQUNMLEFBQUc7b0JBQUMsQUFBSSxLQUFDLEFBQWEsQUFBQyxBQUFDLEFBQ3pCLEFBQ0Y7QUFFRDs7ZUFBTyxBQUFHLEFBQUMsQUFDYixBQUFDLEFBRUQsQUFBUTs7OzJEQUFpQixBQUFLLElBQzVCO1lBQUksQUFBSSxPQUFHLEFBQUUsR0FBQyxBQUFDLEFBQUMsQUFBQyxBQUNqQjtZQUFJLEFBQU8sVUFBRyxBQUFFLEdBQUMsQUFBQyxBQUFDLEFB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OztxRUFBQyxBQUFXLEtBQUcsQUFBQyxBQUM3QixBQUFNOzt1REFBQyxBQUFTLEtBQUcsQUFBQyxBQUNyQjs7Ozs0QkFqSUcsQUFBTyxBQUFNO21CQUFDLEFBQUksS0FBQyxBQUFXLFlBQUMsQUFBTyxBQUFFLEFBQXNDLEFBQUMsQUFBQyxBQUNsRixBQUFDLEFBRUQsQUFBWTs7Ozs7O0FBZ0lkLFNBQVMsQUFBTyxRQUFDLEFBQVksTUFBRSxBQUFvQixTQUNqRDtXQUFPLEFBQU8sV0FBSSxBQUFPLFFBQUMsQUFBRyxJQUFDLEFBQUksQUFBQyxBQUFDLEFBQ3RDLEFBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21waWxlck9wcywgUHJvY2Vzc29yLCBPcCwgT3BOYW1lLCBUZW1wbGF0ZUNvbXBpbGVyT3BzLCBQYXRoSGVhZCB9IGZyb20gJy4vY29tcGlsZXItb3BzJztcbmltcG9ydCB7IEFTVCB9IGZyb20gJ0BnbGltbWVyL3N5bnRheCc7XG5pbXBvcnQgeyBPcHRpb24sIE9wYXF1ZSB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgU3RhY2ssIGV4cGVjdCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgU3ltYm9sVGFibGUgfSBmcm9tICcuL3RlbXBsYXRlLXZpc2l0b3InO1xuXG5leHBvcnQgdHlwZSBJblZhcmlhYmxlID0gUGF0aEhlYWQ7XG5leHBvcnQgdHlwZSBPdXRWYXJpYWJsZSA9IG51bWJlcjtcblxuZXhwb3J0IHR5cGUgT3V0T3A8SyBleHRlbmRzIGtleW9mIENvbXBpbGVyT3BzPE91dFZhcmlhYmxlPiA9IE9wTmFtZT4gPSBPcDxcbiAgT3V0VmFyaWFibGUsXG4gIENvbXBpbGVyT3BzPE91dFZhcmlhYmxlPixcbiAgS1xuPjtcbmV4cG9ydCB0eXBlIEluT3A8SyBleHRlbmRzIGtleW9mIFRlbXBsYXRlQ29tcGlsZXJPcHMgPSBrZXlvZiBUZW1wbGF0ZUNvbXBpbGVyT3BzPiA9IE9wPFxuICBQYXRoSGVhZCxcbiAgVGVtcGxhdGVDb21waWxlck9wcyxcbiAgS1xuPjtcblxuZXhwb3J0IGNsYXNzIFN5bWJvbEFsbG9jYXRvclxuICBpbXBsZW1lbnRzIFByb2Nlc3NvcjxDb21waWxlck9wczxJblZhcmlhYmxlPiwgT3V0VmFyaWFibGUsIENvbXBpbGVyT3BzPE91dFZhcmlhYmxlPj4ge1xuICBwcml2YXRlIHN5bWJvbFN0YWNrID0gbmV3IFN0YWNrPFN5bWJvbFRhYmxlPigpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgb3BzOiBBcnJheTxJbk9wPikge31cblxuICBwcm9jZXNzKCk6IE91dE9wW10ge1xuICAgIGxldCBvdXQ6IE91dE9wW10gPSBbXTtcbiAgICBsZXQgeyBvcHMgfSA9IHRoaXM7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9wcy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IG9wID0gb3BzW2ldO1xuICAgICAgbGV0IHJlc3VsdCA9IHRoaXMuZGlzcGF0Y2gob3ApO1xuXG4gICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgb3V0LnB1c2gob3AgYXMgT3V0T3ApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3V0LnB1c2gocmVzdWx0IGFzIGFueSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG91dDtcbiAgfVxuXG4gIGRpc3BhdGNoPE8gZXh0ZW5kcyBJbk9wPihvcDogTyk6IE9wYXF1ZSB7XG4gICAgbGV0IG5hbWUgPSBvcFswXTtcbiAgICBsZXQgb3BlcmFuZCA9IG9wWzFdO1xuXG4gICAgcmV0dXJuICh0aGlzW25hbWVdIGFzIGFueSkob3BlcmFuZCk7XG4gIH1cblxuICBnZXQgc3ltYm9scygpOiBTeW1ib2xUYWJsZSB7XG4gICAgcmV0dXJuIGV4cGVjdCh0aGlzLnN5bWJvbFN0YWNrLmN1cnJlbnQsICdFeHBlY3RlZCBhIHN5bWJvbCB0YWJsZSBvbiB0aGUgc3RhY2snKTtcbiAgfVxuXG4gIHN0YXJ0UHJvZ3JhbShvcDogQVNULlByb2dyYW0pIHtcbiAgICB0aGlzLnN5bWJvbFN0YWNrLnB1c2gob3BbJ3N5bWJvbHMnXSk7XG4gIH1cblxuICBlbmRQcm9ncmFtKF9vcDogbnVsbCkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucG9wKCk7XG4gIH1cblxuICBzdGFydEJsb2NrKG9wOiBBU1QuUHJvZ3JhbSkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucHVzaChvcFsnc3ltYm9scyddKTtcbiAgfVxuXG4gIGVuZEJsb2NrKF9vcDogbnVsbCkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucG9wKCk7XG4gIH1cblxuICBmbHVzaEVsZW1lbnQob3A6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucHVzaChvcFsnc3ltYm9scyddKTtcbiAgfVxuXG4gIGNsb3NlRWxlbWVudChfb3A6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucG9wKCk7XG4gIH1cblxuICBjbG9zZUNvbXBvbmVudChfb3A6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucG9wKCk7XG4gIH1cblxuICBjbG9zZUR5bmFtaWNDb21wb25lbnQoX29wOiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICB0aGlzLnN5bWJvbFN0YWNrLnBvcCgpO1xuICB9XG5cbiAgYXR0clNwbGF0KF9vcDogT3B0aW9uPEluVmFyaWFibGU+KTogT3V0T3A8J2F0dHJTcGxhdCc+IHtcbiAgICByZXR1cm4gWydhdHRyU3BsYXQnLCB0aGlzLnN5bWJvbHMuYWxsb2NhdGVCbG9jaygnYXR0cnMnKV07XG4gIH1cblxuICBnZXQob3A6IFtJblZhcmlhYmxlLCBzdHJpbmdbXV0pOiBPdXRPcDwnZ2V0JyB8ICdtYXliZUxvY2FsJz4ge1xuICAgIGxldCBbbmFtZSwgcmVzdF0gPSBvcDtcblxuICAgIGlmIChuYW1lID09PSAwKSB7XG4gICAgICByZXR1cm4gWydnZXQnLCBbMCwgcmVzdF1dO1xuICAgIH1cblxuICAgIGlmIChpc0xvY2FsKG5hbWUsIHRoaXMuc3ltYm9scykpIHtcbiAgICAgIGxldCBoZWFkID0gdGhpcy5zeW1ib2xzLmdldChuYW1lKTtcbiAgICAgIHJldHVybiBbJ2dldCcsIFtoZWFkLCByZXN0XV07XG4gICAgfSBlbHNlIGlmIChuYW1lWzBdID09PSAnQCcpIHtcbiAgICAgIGxldCBoZWFkID0gdGhpcy5zeW1ib2xzLmFsbG9jYXRlTmFtZWQobmFtZSk7XG4gICAgICByZXR1cm4gWydnZXQnLCBbaGVhZCwgcmVzdF1dO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gWydtYXliZUxvY2FsJywgW25hbWUsIC4uLnJlc3RdXTtcbiAgICB9XG4gIH1cblxuICBtYXliZUdldChvcDogW0luVmFyaWFibGUsIHN0cmluZ1tdXSk6IE91dE9wPCdnZXQnIHwgJ3Vua25vd24nIHwgJ21heWJlTG9jYWwnPiB7XG4gICAgbGV0IFtuYW1lLCByZXN0XSA9IG9wO1xuXG4gICAgaWYgKG5hbWUgPT09IDApIHtcbiAgICAgIHJldHVybiBbJ2dldCcsIFswLCByZXN0XV07XG4gICAgfVxuXG4gICAgaWYgKGlzTG9jYWwobmFtZSwgdGhpcy5zeW1ib2xzKSkge1xuICAgICAgbGV0IGhlYWQgPSB0aGlzLnN5bWJvbHMuZ2V0KG5hbWUpO1xuICAgICAgcmV0dXJuIFsnZ2V0JywgW2hlYWQsIHJlc3RdXTtcbiAgICB9IGVsc2UgaWYgKG5hbWVbMF0gPT09ICdAJykge1xuICAgICAgbGV0IGhlYWQgPSB0aGlzLnN5bWJvbHMuYWxsb2NhdGVOYW1lZChuYW1lKTtcbiAgICAgIHJldHVybiBbJ2dldCcsIFtoZWFkLCByZXN0XV07XG4gICAgfSBlbHNlIGlmIChyZXN0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFsndW5rbm93bicsIG5hbWVdO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gWydtYXliZUxvY2FsJywgW25hbWUsIC4uLnJlc3RdXTtcbiAgICB9XG4gIH1cblxuICB5aWVsZChvcDogSW5WYXJpYWJsZSk6IE91dE9wPCd5aWVsZCc+IHtcbiAgICBpZiAob3AgPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHlpZWxkIHRvIHRoaXMnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gWyd5aWVsZCcsIHRoaXMuc3ltYm9scy5hbGxvY2F0ZUJsb2NrKG9wKV07XG4gIH1cblxuICBkZWJ1Z2dlcihfb3A6IE9wdGlvbjxJblZhcmlhYmxlW10+KTogT3V0T3A8J2RlYnVnZ2VyJz4ge1xuICAgIHJldHVybiBbJ2RlYnVnZ2VyJywgdGhpcy5zeW1ib2xzLmdldEV2YWxJbmZvKCldO1xuICB9XG5cbiAgaGFzQmxvY2sob3A6IEluVmFyaWFibGUpOiBPdXRPcDwnaGFzQmxvY2snPiB7XG4gICAgaWYgKG9wID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBoYXNCbG9jayB0aGlzJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFsnaGFzQmxvY2snLCB0aGlzLnN5bWJvbHMuYWxsb2NhdGVCbG9jayhvcCldO1xuICB9XG5cbiAgaGFzQmxvY2tQYXJhbXMob3A6IEluVmFyaWFibGUpOiBPdXRPcDwnaGFzQmxvY2tQYXJhbXMnPiB7XG4gICAgaWYgKG9wID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBoYXNCbG9ja1BhcmFtcyB0aGlzJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFsnaGFzQmxvY2tQYXJhbXMnLCB0aGlzLnN5bWJvbHMuYWxsb2NhdGVCbG9jayhvcCldO1xuICB9XG5cbiAgcGFydGlhbChfb3A6IE9wdGlvbjxJblZhcmlhYmxlW10+KTogT3V0T3A8J3BhcnRpYWwnPiB7XG4gICAgcmV0dXJuIFsncGFydGlhbCcsIHRoaXMuc3ltYm9scy5nZXRFdmFsSW5mbygpXTtcbiAgfVxuXG4gIHRleHQoX29wOiBzdHJpbmcpIHt9XG4gIGNvbW1lbnQoX29wOiBzdHJpbmcpIHt9XG4gIG9wZW5Db21wb25lbnQoX29wOiBBU1QuRWxlbWVudE5vZGUpIHt9XG4gIG9wZW5FbGVtZW50KF9vcDogQVNULkVsZW1lbnROb2RlKSB7fVxuICBvcGVuU3BsYXR0ZWRFbGVtZW50KF9vcDogQVNULkVsZW1lbnROb2RlKSB7fVxuICBzdGF0aWNBcmcoX29wOiBzdHJpbmcpIHt9XG4gIGR5bmFtaWNBcmcoX29wOiBzdHJpbmcpIHt9XG4gIHN0YXRpY0F0dHIoX29wOiBbc3RyaW5nLCBPcHRpb248c3RyaW5nPl0pIHt9XG4gIHRydXN0aW5nQXR0cihfb3A6IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge31cbiAgZHluYW1pY0F0dHIoX29wOiBbc3RyaW5nLCBPcHRpb248c3RyaW5nPl0pIHt9XG4gIG1vZGlmaWVyKF9vcDogc3RyaW5nKSB7fVxuICBhcHBlbmQoX29wOiBib29sZWFuKSB7fVxuICBibG9jayhfb3A6IFtzdHJpbmcsIG51bWJlciwgT3B0aW9uPG51bWJlcj5dKSB7fVxuICBsaXRlcmFsKF9vcDogc3RyaW5nIHwgYm9vbGVhbiB8IG51bWJlciB8IG51bGwgfCB1bmRlZmluZWQpIHt9XG4gIGhlbHBlcihfb3A6IHN0cmluZykge31cbiAgdW5rbm93bihfb3A6IHN0cmluZykge31cbiAgbWF5YmVMb2NhbChfb3A6IHN0cmluZ1tdKSB7fVxuICBwcmVwYXJlQXJyYXkoX29wOiBudW1iZXIpIHt9XG4gIHByZXBhcmVPYmplY3QoX29wOiBudW1iZXIpIHt9XG4gIGNvbmNhdChfb3A6IG51bGwpIHt9XG59XG5cbmZ1bmN0aW9uIGlzTG9jYWwobmFtZTogc3RyaW5nLCBzeW1ib2xzOiBTeW1ib2xUYWJsZSk6IGJvb2xlYW4ge1xuICByZXR1cm4gc3ltYm9scyAmJiBzeW1ib2xzLmhhcyhuYW1lKTtcbn1cbiJdfQ==